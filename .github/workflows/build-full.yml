name: Build Full PowerToys

on:
  push:
    branches: [ feat/fanzyzones-keyboard-shortcut-qol ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  BUILD_PLATFORM: x64
  BUILD_CONFIGURATION: Release
  VERSION_NUMBER: 0.0.1-dev

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 120
    name: Build x64 Release + Installer

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Install WiX 5.0.2 tools
      run: dotnet tool install --global wix --version 5.0.2

    - name: Restore NuGet packages (packages.config style for C++)
      shell: pwsh
      run: |
        # Restore packages.config-style NuGet packages (C++ projects)
        nuget restore PowerToys.slnx -ConfigFile nuget.config

    - name: Build PowerToys
      shell: pwsh
      run: |
        # Build using PowerToys' official build script
        # CIBuild=true skips post-build steps that execute binaries
        ./tools/build/build.ps1 -Configuration $env:BUILD_CONFIGURATION -Platform $env:BUILD_PLATFORM '/p:CIBuild=true'

    - name: Patch installer script for PowerShell compatibility
      shell: pwsh
      run: |
        # Fix New-Guid cmdlet issue - use [Guid]::NewGuid() which works in all PS versions
        # The MSBuild pre-build event uses powershell.exe which may have issues with New-Guid
        $scriptPath = "installer/PowerToysSetupVNext/generateAllFileComponents.ps1"
        $content = Get-Content $scriptPath -Raw
        $content = $content -replace '\(New-Guid\)', '([Guid]::NewGuid())'
        Set-Content -Path $scriptPath -Value $content -NoNewline
        Write-Host "Patched $scriptPath for PowerShell compatibility"

    - name: Build Installer - Custom Actions DLLs
      shell: pwsh
      run: |
        # Build shared support DLLs first (CustomActions and SilentFilesInUseBAFunction)
        # RunBuildEvents=true generates the .wxs files with component lists
        msbuild installer/PowerToysSetup.slnx `
          /t:PowerToysSetupCustomActionsVNext`;SilentFilesInUseBAFunction `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:Configuration=$env:BUILD_CONFIGURATION `
          /p:RunBuildEvents=true `
          /p:RestorePackagesConfig=true `
          /p:CIBuild=true `
          -restore -graph `
          /verbosity:minimal

    - name: Build Installer - Machine MSI
      shell: pwsh
      run: |
        # Build MSI for machine-wide installation
        msbuild installer/PowerToysSetup.slnx `
          /t:PowerToysInstallerVNext `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:Configuration=$env:BUILD_CONFIGURATION `
          /p:RunBuildEvents=false `
          /p:PerUser=false `
          /p:BuildProjectReferences=false `
          /p:CIBuild=true `
          -restore `
          /verbosity:minimal

    - name: Build Installer - User MSI
      shell: pwsh
      run: |
        # Build MSI for per-user installation
        msbuild installer/PowerToysSetup.slnx `
          /t:PowerToysInstallerVNext `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:Configuration=$env:BUILD_CONFIGURATION `
          /p:RunBuildEvents=false `
          /p:PerUser=true `
          /p:BuildProjectReferences=false `
          /p:CIBuild=true `
          /verbosity:minimal

    - name: Build Installer - Machine Bootstrapper
      shell: pwsh
      run: |
        # Build EXE bootstrapper for machine-wide installation
        msbuild installer/PowerToysSetup.slnx `
          /t:PowerToysBootstrapperVNext `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:Configuration=$env:BUILD_CONFIGURATION `
          /p:PerUser=false `
          /p:BuildProjectReferences=false `
          /p:CIBuild=true `
          -restore `
          /verbosity:minimal

    - name: Build Installer - User Bootstrapper
      shell: pwsh
      run: |
        # Build EXE bootstrapper for per-user installation
        msbuild installer/PowerToysSetup.slnx `
          /t:PowerToysBootstrapperVNext `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:Configuration=$env:BUILD_CONFIGURATION `
          /p:PerUser=true `
          /p:BuildProjectReferences=false `
          /p:CIBuild=true `
          /verbosity:minimal

    - name: List installer outputs
      shell: pwsh
      run: |
        Write-Host "=== Machine Installer ==="
        Get-ChildItem -Path "installer/PowerToysSetupVNext/$env:BUILD_PLATFORM/$env:BUILD_CONFIGURATION/MachineSetup" -ErrorAction SilentlyContinue
        Write-Host "`n=== User Installer ==="
        Get-ChildItem -Path "installer/PowerToysSetupVNext/$env:BUILD_PLATFORM/$env:BUILD_CONFIGURATION/UserSetup" -ErrorAction SilentlyContinue

    - name: Display error log on failure
      if: failure()
      shell: pwsh
      run: |
        $errorLog = "build.release.x64.errors.log"
        if (Test-Path $errorLog) {
          Write-Host "=== Error Log Contents ==="
          Get-Content $errorLog | Select-Object -First 100
        } else {
          Write-Host "Error log not found: $errorLog"
        }

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build.*.*.log
          build.*.*.binlog
          **/build.*.*.log
          **/build.*.*.binlog
        retention-days: 7
        if-no-files-found: warn

    - name: Upload Installer artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: PowerToys-Installers-x64
        path: |
          installer/PowerToysSetupVNext/x64/Release/MachineSetup/*.msi
          installer/PowerToysSetupVNext/x64/Release/MachineSetup/*.exe
          installer/PowerToysSetupVNext/x64/Release/UserSetup/*.msi
          installer/PowerToysSetupVNext/x64/Release/UserSetup/*.exe
        retention-days: 14
