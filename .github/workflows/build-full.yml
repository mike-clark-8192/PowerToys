name: Build Full PowerToys

on:
  push:
    branches: [ feat/fanzyzones-keyboard-shortcut-qol ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  BUILD_PLATFORM: x64
  BUILD_CONFIGURATION: Release
  VERSION_NUMBER: 0.0.1-dev
  NUGET_PACKAGES: C:\Users\runneradmin\.nuget\packages

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 120
    name: Build x64 Release + Installer

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Install Windows SDK 10.0.19041.0
      shell: pwsh
      run: |
        # CsWinRT requires Windows SDK 10.0.19041.0 for TargetPlatformMinVersion validation
        # Install the full SDK using winget (VS Installer component doesn't include full SDK)
        Write-Host "Installing Windows SDK 10.0.19041.0 via winget..."
        winget install Microsoft.WindowsSDK.10.0.19041 --silent --accept-package-agreements --accept-source-agreements

        # Give time for installation to complete
        Start-Sleep -Seconds 10

        Write-Host "Verifying SDK installation..."
        $sdkPath = "C:\Program Files (x86)\Windows Kits\10\Platforms\UAP\10.0.19041.0"
        if (Test-Path $sdkPath) {
          Write-Host "SDK 10.0.19041.0 installed successfully"
          Get-ChildItem $sdkPath
        } else {
          Write-Host "Warning: SDK path not found at $sdkPath"
          Write-Host "Available SDKs:"
          Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\Platforms\UAP\" -ErrorAction SilentlyContinue
        }

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Install WiX 5.0.2 tools
      run: dotnet tool install --global wix --version 5.0.2

    - name: Restore NuGet packages (packages.config style for C++)
      shell: pwsh
      run: |
        # Restore packages.config-style NuGet packages (C++ projects)
        nuget restore PowerToys.slnx -ConfigFile nuget.config

    - name: Build PowerToys
      shell: pwsh
      run: |
        # Build using PowerToys' official build script
        # CIBuild=true skips post-build steps that execute binaries
        ./tools/build/build.ps1 -Configuration $env:BUILD_CONFIGURATION -Platform $env:BUILD_PLATFORM '/p:CIBuild=true'

    - name: Patch installer scripts for PowerShell compatibility
      shell: pwsh
      run: |
        # Fix New-Guid cmdlet issue - use [Guid]::NewGuid() which works in all PS versions
        # The MSBuild pre-build event uses powershell.exe which may have issues with New-Guid
        $scripts = @(
          "installer/PowerToysSetupVNext/generateAllFileComponents.ps1",
          "installer/PowerToysSetupVNext/generateMonacoWxs.ps1"
        )
        foreach ($scriptPath in $scripts) {
          if (Test-Path $scriptPath) {
            $content = Get-Content $scriptPath -Raw
            $content = $content -replace '\(New-Guid\)', '([Guid]::NewGuid())'
            Set-Content -Path $scriptPath -Value $content -NoNewline
            Write-Host "Patched $scriptPath for PowerShell compatibility"
          }
        }

    - name: Create DSC module placeholders
      shell: pwsh
      run: |
        # DSC module generation requires running PowerToys.DSC.exe which is complex
        # Create placeholder structure for installer to proceed
        $version = $env:VERSION_NUMBER.TrimEnd('-dev')
        Write-Host "VERSION_NUMBER=$env:VERSION_NUMBER, version=$version"
        $dscPath = "src\dsc\Microsoft.PowerToys.Configure\Generated\Microsoft.PowerToys.Configure\$version.0"
        Write-Host "Creating DSC path: $dscPath"
        New-Item -ItemType Directory -Force -Path $dscPath
        # Create minimal placeholder files (installer will include them but they won't be functional)
        "# Placeholder - DSC not generated in CI build" | Set-Content "$dscPath\Microsoft.PowerToys.Configure.psd1"
        "# Placeholder - DSC not generated in CI build" | Set-Content "$dscPath\Microsoft.PowerToys.Configure.psm1"
        Write-Host "DSC placeholder files:"
        Get-ChildItem $dscPath
        # Create DSCModules output directory
        $dscModulesPath = "$env:BUILD_PLATFORM\Release\DSCModules"
        New-Item -ItemType Directory -Force -Path $dscModulesPath
        Write-Host "Created DSC placeholders at $dscPath and $dscModulesPath"

    - name: Build Installer - Custom Actions DLLs
      shell: pwsh
      run: |
        # Build shared support DLLs first (CustomActions and SilentFilesInUseBAFunction)
        # RunBuildEvents=true generates the .wxs files with component lists
        $version = $env:VERSION_NUMBER.TrimEnd('-dev')
        msbuild installer/PowerToysSetup.slnx `
          /t:PowerToysSetupCustomActionsVNext`;SilentFilesInUseBAFunction `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:Configuration=$env:BUILD_CONFIGURATION `
          /p:Version=$version `
          /p:RunBuildEvents=true `
          /p:RestorePackagesConfig=true `
          /p:CIBuild=true `
          -restore -graph `
          /verbosity:minimal

    - name: Patch WiX files for WiX 5 compatibility
      shell: pwsh
      run: |
        # Patch WiX files to add Name attributes AFTER generateAllFileComponents.ps1 runs
        # WiX 5 requires explicit Name when Source uses variables
        $dscWxsPath = "installer\PowerToysSetupVNext\DscResources.wxs"
        $content = Get-Content $dscWxsPath -Raw

        # Add Name attributes to DSC file references
        $content = $content -replace 'Id="PTConfReference.psd1" />', 'Id="PTConfReference.psd1" Name="Microsoft.PowerToys.Configure.psd1" />'
        $content = $content -replace 'Id="PTConfReference.psm1" />', 'Id="PTConfReference.psm1" Name="Microsoft.PowerToys.Configure.psm1" />'

        # Remove the invalid empty DscJsonFiles component generated when DSCModules folder is empty
        # The script generates: <File Id="DscJsonFiles_File_" Source="$(var.DscJsonFilesPath)\" /> which is invalid
        $content = $content -replace '(?s)<Component Id="DscJsonFiles_Component"[^>]*>.*?</Component>\s*', ''
        # Also remove the ComponentRef for it
        $content = $content -replace '<ComponentRef Id="DscJsonFiles_Component"\s*/>\s*', ''

        Set-Content -Path $dscWxsPath -Value $content -NoNewline
        Write-Host "Patched $dscWxsPath"

        $coreWxsPath = "installer\PowerToysSetupVNext\Core.wxs"
        $content = Get-Content $coreWxsPath -Raw
        $content = $content -replace 'Id="PTConf.psd1" />', 'Id="PTConf.psd1" Name="Microsoft.PowerToys.Configure.psd1" />'
        $content = $content -replace 'Id="PTConf.psm1" />', 'Id="PTConf.psm1" Name="Microsoft.PowerToys.Configure.psm1" />'
        Set-Content -Path $coreWxsPath -Value $content -NoNewline
        Write-Host "Patched Core.wxs with explicit Name attributes"

    - name: Build Installer - Machine MSI
      shell: pwsh
      env:
        # Environment variable to skip IIDOptimizer which fails in CI
        CsWinRTIIDOptimizerOptOut: true
      run: |
        # Build MSI for machine-wide installation
        $version = $env:VERSION_NUMBER.TrimEnd('-dev')
        msbuild installer/PowerToysSetup.slnx `
          /t:PowerToysInstallerVNext `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:Configuration=$env:BUILD_CONFIGURATION `
          /p:Version=$version `
          /p:RunBuildEvents=false `
          /p:PerUser=false `
          /p:BuildProjectReferences=false `
          /p:CIBuild=true `
          /p:CsWinRTIIDOptimizerOptOut=true `
          -restore `
          /verbosity:minimal

    - name: Build Installer - User MSI
      shell: pwsh
      env:
        CsWinRTIIDOptimizerOptOut: true
      run: |
        # Build MSI for per-user installation
        $version = $env:VERSION_NUMBER.TrimEnd('-dev')
        msbuild installer/PowerToysSetup.slnx `
          /t:PowerToysInstallerVNext `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:Configuration=$env:BUILD_CONFIGURATION `
          /p:Version=$version `
          /p:RunBuildEvents=false `
          /p:PerUser=true `
          /p:BuildProjectReferences=false `
          /p:CIBuild=true `
          /p:CsWinRTIIDOptimizerOptOut=true `
          /verbosity:minimal

    - name: Build Installer - Machine Bootstrapper
      shell: pwsh
      env:
        CsWinRTIIDOptimizerOptOut: true
      run: |
        # Build EXE bootstrapper for machine-wide installation
        $version = $env:VERSION_NUMBER.TrimEnd('-dev')
        msbuild installer/PowerToysSetup.slnx `
          /t:PowerToysBootstrapperVNext `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:Configuration=$env:BUILD_CONFIGURATION `
          /p:Version=$version `
          /p:PerUser=false `
          /p:BuildProjectReferences=false `
          /p:CIBuild=true `
          /p:CsWinRTIIDOptimizerOptOut=true `
          -restore `
          /verbosity:minimal

    - name: Build Installer - User Bootstrapper
      shell: pwsh
      env:
        CsWinRTIIDOptimizerOptOut: true
      run: |
        # Build EXE bootstrapper for per-user installation
        $version = $env:VERSION_NUMBER.TrimEnd('-dev')
        msbuild installer/PowerToysSetup.slnx `
          /t:PowerToysBootstrapperVNext `
          /p:Platform=$env:BUILD_PLATFORM `
          /p:Configuration=$env:BUILD_CONFIGURATION `
          /p:Version=$version `
          /p:PerUser=true `
          /p:BuildProjectReferences=false `
          /p:CIBuild=true `
          /p:CsWinRTIIDOptimizerOptOut=true `
          /verbosity:minimal

    - name: List installer outputs
      shell: pwsh
      run: |
        Write-Host "=== Machine Installer ==="
        Get-ChildItem -Path "installer/PowerToysSetupVNext/$env:BUILD_PLATFORM/$env:BUILD_CONFIGURATION/MachineSetup" -ErrorAction SilentlyContinue
        Write-Host "`n=== User Installer ==="
        Get-ChildItem -Path "installer/PowerToysSetupVNext/$env:BUILD_PLATFORM/$env:BUILD_CONFIGURATION/UserSetup" -ErrorAction SilentlyContinue

    - name: Display error log on failure
      if: failure()
      shell: pwsh
      run: |
        $errorLog = "build.release.x64.errors.log"
        if (Test-Path $errorLog) {
          Write-Host "=== Error Log Contents ==="
          Get-Content $errorLog | Select-Object -First 100
        } else {
          Write-Host "Error log not found: $errorLog"
        }

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build.*.*.log
          build.*.*.binlog
          **/build.*.*.log
          **/build.*.*.binlog
        retention-days: 7
        if-no-files-found: warn

    - name: Upload Installer artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: PowerToys-Installers-x64
        path: |
          installer/PowerToysSetupVNext/x64/Release/MachineSetup/*.msi
          installer/PowerToysSetupVNext/x64/Release/MachineSetup/*.exe
          installer/PowerToysSetupVNext/x64/Release/UserSetup/*.msi
          installer/PowerToysSetupVNext/x64/Release/UserSetup/*.exe
        retention-days: 14
