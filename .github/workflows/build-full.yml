name: Build Full PowerToys

on:
  push:
    branches: [ feat/fanzyzones-keyboard-shortcut-qol ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    strategy:
      matrix:
        platform: [x64, ARM64]
        configuration: [Debug, Release]
      fail-fast: false  # Continue other builds even if one fails

    runs-on: windows-latest
    timeout-minutes: 90
    name: Build ${{ matrix.platform }} ${{ matrix.configuration }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages (packages.config style for C++)
      shell: pwsh
      run: |
        # Restore packages.config-style NuGet packages (C++ projects)
        # MSBuild /t:restore only handles PackageReference, not packages.config
        nuget restore PowerToys.slnx -ConfigFile nuget.config

    - name: Build PowerToys
      shell: pwsh
      run: |
        # Build using PowerToys' official build script
        # NuGet packages already restored above
        # CIBuild=true skips post-build steps that execute binaries (needed for ARM64 cross-compilation)
        ./tools/build/build.ps1 -Configuration ${{ matrix.configuration }} -Platform ${{ matrix.platform }} '/p:CIBuild=true'

    - name: Display error log on failure
      if: failure()
      shell: pwsh
      run: |
        $cfg = "${{ matrix.configuration }}".ToLower()
        $plat = "${{ matrix.platform }}".ToLower()
        $errorLog = "build.$cfg.$plat.errors.log"
        if (Test-Path $errorLog) {
          Write-Host "=== Error Log Contents ==="
          Get-Content $errorLog | Select-Object -First 100
        } else {
          Write-Host "Error log not found: $errorLog"
        }

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.platform }}-${{ matrix.configuration }}
        path: |
          build.*.*.log
          build.*.*.binlog
          **/build.*.*.log
          **/build.*.*.binlog
        retention-days: 7
        if-no-files-found: warn

    - name: Upload build artifacts on success
      if: success() && matrix.configuration == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: PowerToys-${{ matrix.platform }}-Release
        path: |
          x64/Release/**/*.exe
          x64/Release/**/*.dll
          ARM64/Release/**/*.exe
          ARM64/Release/**/*.dll
        retention-days: 14
